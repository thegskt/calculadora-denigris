<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Estoque DN</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f8fb;color:#0b1a2b}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .tools{display:flex;gap:8px;flex:1 1 260px}
    .tools input[type=search]{flex:1 1 auto;padding:10px 12px;border:1px solid #ccd3dd;border-radius:8px;min-width:240px}
    .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;min-height:40px}
    .btn-primary{background:#23408e;color:#fff}

    /* Accordion */
    #groups{display:flex;flex-direction:column;gap:12px}
    .acc{background:#fff;border:1px solid #e2e7ef;border-radius:12px;overflow:hidden}
    .acc-h{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;cursor:pointer;background:#eef3ff}
    .acc-title{display:flex;align-items:center;gap:10px;font-weight:700}
    .badge{background:#dde6ff;color:#1e2f5c;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:700}
    .chev{transition:transform .2s ease}
    .acc.open .chev{transform:rotate(180deg)}
    .acc-c{display:none}
    .acc.open .acc-c{display:block}

    /* Lista interna (linhas) */
    .rows{display:flex;flex-direction:column}
    .row{display:grid;grid-template-columns: 90px 1fr 80px 80px 140px 120px;gap:10px;align-items:center;padding:10px 14px;border-top:1px solid #eef2f7}
    .row:first-child{border-top:0}
    .fz{font-weight:700}
    .right{text-align:right}
    .muted{color:#5b6b82}

    /* Cabeçalho das colunas (desktop) */
    .cols{display:grid;grid-template-columns: 90px 1fr 80px 80px 140px 120px;gap:10px;font-weight:700;padding:10px 14px;border-top:1px solid #e2e7ef;border-bottom:1px solid #eef2f7;background:#fafcff}

    /* Mobile: cards */
    @media (max-width:720px){
      .tools input[type=search]{min-width:0;width:100%}
      .cols{display:none}
      .acc-h{padding:10px 12px}
      .row{
        display:grid;
        grid-template-columns: 1fr 1fr; /* duas colunas */
        gap:8px 12px;
        padding:8px 12px;
      }
      /* Cada célula mostra rótulo curto + valor, lado a lado */
      .row > div{
        display:flex;
        align-items:center;
        gap:6px;
      }
      .row > div::before{
        content: attr(data-label) ": ";
        font-weight:700;
        color:#4b5d78;
      }
      /* Posiciona os itens em 3 linhas x 2 colunas */
      .row > div:nth-child(1){ grid-column:1; grid-row:1; } /* FZ */
      .row > div:nth-child(2){ grid-column:2; grid-row:1; } /* Modelo */
      .row > div:nth-child(3){ grid-column:1; grid-row:2; } /* UP */
      .row > div:nth-child(4){ grid-column:2; grid-row:2; } /* Ano */
      .row > div:nth-child(5){ grid-column:1; grid-row:3; } /* Valor */
      .row > div:nth-child(6){ grid-column:2; grid-row:3; } /* Botão */

      .btn-primary{width:100%} /* botão ocupa a coluna inteira */
      /* Ajusta rótulo longo para curto só no mobile */
      .row > div[data-label="Valor Tabela"]::before{ content: "Valor: "; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Estoque De Nigris</h1>
      <div class="tools">
        <input id="busca" type="search" placeholder="Buscar por FZ, modelo, UP ou ano...">
      </div>
    </header>

    <div id="groups"></div>
  </div>

  <script>
    // Fonte de dados (CSV do Google Sheets)
    const sheetCsvUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeqk-5eBeAxB4GesiaM7W6iEUq9lgfTsRzdy1QylG1ak7dX35Ol827EM1c7LPWb97BoBh6iUbtJMMw"
      + "/pub?gid=2122951741&single=true&output=csv";

    const busca = document.getElementById('busca');
    const groupsEl = document.getElementById('groups');
    let itens = [];

    const FAM_ORDER = ['Accelo','Atego','Actros','Axor','Arocs','Outros'];

    function fmtBRL(v){
      if (isNaN(v)) return "R$ 0,00";
      return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function normFamily(modelo=''){
      const famRaw = (modelo || '').trim().split(/\s+/)[0].toUpperCase();
      switch (famRaw) {
        case 'ACCELO': return 'Accelo';
        case 'ATEGO':  return 'Atego';
        case 'ACTROS': return 'Actros';
        case 'AXOR':   return 'Axor';
        case 'AROCS':  return 'Arocs';
        default:       return 'Outros';
      }
    }
    function groupByFamily(list){
      const map = new Map();
      for (const it of list){
        const fam = normFamily(it.modelo);
        if (!map.has(fam)) map.set(fam, []);
        map.get(fam).push(it);
      }
      // ordena por ordem desejada e remove famílias vazias
      const arr = [];
      for (const fam of FAM_ORDER){
        if (map.has(fam)) arr.push({ name:fam, items: map.get(fam) });
      }
      return arr;
    }

    function render(list){
      groupsEl.innerHTML = '';
      const groups = groupByFamily(list);

      for (const g of groups){
        const acc = document.createElement('section');
        acc.className = 'acc';

        // header
        const h = document.createElement('div');
        h.className = 'acc-h';
        h.setAttribute('role','button');
        h.setAttribute('tabindex','0');
        h.setAttribute('aria-expanded','false');

        const left = document.createElement('div');
        left.className = 'acc-title';
        const title = document.createElement('span');
        title.textContent = g.name;
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = g.items.length;
        left.append(title, badge);

        const chev = document.createElement('span');
        chev.className = 'chev';
        chev.textContent = '▾';

        h.append(left, chev);

        // content
        const c = document.createElement('div');
        c.className = 'acc-c';

        // header de colunas (desktop)
        const cols = document.createElement('div');
        cols.className = 'cols';
        cols.innerHTML = `
          <div>FZ</div>
          <div>Modelo</div>
          <div>UP</div>
          <div>Ano</div>
          <div class="right">Valor Tabela</div>
          <div>Ação</div>
        `;
        c.appendChild(cols);

        const rows = document.createElement('div');
        rows.className = 'rows';

        for (const r of g.items){
          const row = document.createElement('div');
          row.className = 'row';

          const cFz = document.createElement('div');
          cFz.className = 'fz';
          cFz.textContent = r.fz;
          cFz.setAttribute('data-label','FZ');

          const cMod = document.createElement('div');
          cMod.textContent = r.modelo;
          cMod.className = 'muted';
          cMod.setAttribute('data-label','Modelo');

          const cUp = document.createElement('div');
          cUp.textContent = r.up;
          cUp.setAttribute('data-label','UP');

          const cAno = document.createElement('div');
          cAno.textContent = r.anoMod;
          cAno.setAttribute('data-label','Ano');

          const cVal = document.createElement('div');
          cVal.textContent = fmtBRL(r.valorTabela);
          cVal.className = 'right';
          cVal.setAttribute('data-label','Valor Tabela');

          const cAc = document.createElement('div');
          const a = document.createElement('a');
          a.className = 'btn btn-primary';
          a.textContent = 'Calcular';
          a.href = `index.html?calc=proprio&fz=${encodeURIComponent(r.fz)}`;
          cAc.appendChild(a);

          row.append(cFz, cMod, cUp, cAno, cVal, cAc);
          rows.appendChild(row);
        }

        c.appendChild(rows);
        acc.append(h, c);
        groupsEl.appendChild(acc);

        // toggle
        const toggle = () => {
          const isOpen = acc.classList.toggle('open');
          h.setAttribute('aria-expanded', String(isOpen));
        };
        h.addEventListener('click', toggle);
        h.addEventListener('keydown', (e)=> {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
        });
      }
    }

    function filtrar(){
      const q = busca.value.trim().toLowerCase();
      if (!q) { render(itens); return; }
      const qNum = q.replace(/\D/g,'');
      const f = itens.filter(r =>
        r.fz.includes(qNum) ||
        r.modelo.toLowerCase().includes(q) ||
        r.up.toLowerCase().includes(q) ||
        r.anoMod.toLowerCase().includes(q)
      );
      render(f);
      // abre automaticamente as famílias que aparecerem no filtro
      document.querySelectorAll('.acc').forEach(sec => {
        sec.classList.add('open');
        sec.querySelector('.acc-h')?.setAttribute('aria-expanded','true');
      });
    }

    busca.addEventListener('input', filtrar);

    async function carregar(){
      try{
        const res = await fetch(sheetCsvUrl, { cache:'no-store' });
        const txt = await res.text();
        const rows = txt.trim().split('\n');
        rows.shift(); // cabeçalho
        itens = rows.map(line => {
          const cols = line
            .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
            .map(c => c.replace(/^"|"$/g, "").trim());
          return {
            fz: (cols[0] || '').padStart(6, "0"),
            modelo: cols[1] || '',
            up: cols[2] || '',
            anoMod: cols[3] || '',
            valorTabela: parseFloat((cols[4] || '0').replace(/\./g,"").replace(/,/g,".")) || 0
          };
        });
        render(itens);
      }catch(e){
        console.error('Erro ao carregar estoque:', e);
        groupsEl.innerHTML = '<div class="acc"><div class="acc-h"><div class="acc-title"><span>Erro</span></div></div><div class="acc-c"><div class="rows"><div class="row"><div>Não foi possível carregar o estoque.</div></div></div></div></div>';
      }
    }

    carregar();
  </script>
</body>
</html>